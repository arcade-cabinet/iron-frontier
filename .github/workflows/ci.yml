# Iron Frontier - CI/CD Pipeline
# Unity 6 game with WebGL deploy to GitHub Pages and Android APK releases
#
# Workflow:
# 1. Test: Run Unity EditMode tests
# 2. Build: Create WebGL and Android builds
# 3. Deploy: WebGL to GitHub Pages, Android APK via release-please
# 4. E2E: Playwright (WebGL) and Maestro (Android) tests

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, 'release/*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      build_webgl:
        description: 'Build and deploy WebGL'
        type: boolean
        default: true
      build_android:
        description: 'Build Android APK'
        type: boolean
        default: true
      run_e2e:
        description: 'Run E2E tests'
        type: boolean
        default: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  UNITY_VERSION: 6000.3.5f1
  PROJECT_PATH: .

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  # ============================================================
  # Release Please - Changelog and Version Management
  # ============================================================
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # ============================================================
  # Unity Tests
  # ============================================================
  test:
    name: Unity Tests
    runs-on: ubuntu-latest
    outputs:
      test_passed: ${{ steps.test-result.outputs.passed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Test-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Test-
            Library-

      - name: Run EditMode Tests
        uses: game-ci/unity-test-runner@v4
        id: editmode-tests
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: EditMode
          artifactsPath: TestResults
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: EditMode Test Results
          coverageOptions: 'generateAdditionalMetrics;generateHtmlReport;generateBadgeReport'

      - name: Set Test Result
        id: test-result
        run: echo "passed=true" >> $GITHUB_OUTPUT

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: TestResults
          retention-days: 30

      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-results
          path: CodeCoverage
          retention-days: 30

  # ============================================================
  # WebGL Build
  # ============================================================
  build-webgl:
    name: Build WebGL
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.build_webgl == 'true' ||
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-WebGL-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-WebGL-
            Library-

      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: WebGL
          buildName: IronFrontier

      - name: Upload WebGL Build
        uses: actions/upload-artifact@v4
        with:
          name: WebGL-Build
          path: build/WebGL
          retention-days: 30

  # ============================================================
  # Android Build
  # ============================================================
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.build_android == 'true' ||
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Android-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Android-
            Library-

      - name: Build Android (Debug)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: ${{ env.PROJECT_PATH }}
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: Android
          buildName: IronFrontier
          androidAppBundle: false
          # Debug build - no signing required
          androidExportType: androidPackage

      - name: Upload Android Build
        uses: actions/upload-artifact@v4
        with:
          name: Android-Build
          path: build/Android
          retention-days: 30

  # ============================================================
  # Deploy WebGL to GitHub Pages
  # ============================================================
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-webgl, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download WebGL Build
        uses: actions/download-artifact@v4
        with:
          name: WebGL-Build
          path: build/WebGL

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare WebGL for Pages
        run: |
          # Create proper directory structure
          mkdir -p _site
          cp -r build/WebGL/WebGL/* _site/ 2>/dev/null || cp -r build/WebGL/* _site/

          # Create index.html redirect if needed
          if [ ! -f "_site/index.html" ]; then
            echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0;url=IronFrontier/index.html"></head></html>' > _site/index.html
          fi

          # List contents for debugging
          echo "=== Build contents ==="
          find _site -type f | head -50

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ============================================================
  # Upload Android APK to Release
  # ============================================================
  release-android:
    name: Release Android APK
    runs-on: ubuntu-latest
    needs: [build-android, release-please]
    if: needs.release-please.outputs.release_created == 'true'
    steps:
      - name: Download Android Build
        uses: actions/download-artifact@v4
        with:
          name: Android-Build
          path: build/Android

      - name: Find APK file
        id: find-apk
        run: |
          APK_PATH=$(find build/Android -name "*.apk" | head -1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK: $APK_PATH"

      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release-please.outputs.upload_url }}
          asset_path: ${{ steps.find-apk.outputs.apk_path }}
          asset_name: IronFrontier-${{ needs.release-please.outputs.version }}-debug.apk
          asset_content_type: application/vnd.android.package-archive

  # ============================================================
  # Playwright E2E Tests (WebGL)
  # ============================================================
  e2e-webgl:
    name: E2E Tests (WebGL)
    runs-on: ubuntu-latest
    needs: build-webgl
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.run_e2e == 'true' ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download WebGL Build
        uses: actions/download-artifact@v4
        with:
          name: WebGL-Build
          path: Builds/WebGL

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: tests/e2e/package-lock.json

      - name: Install Dependencies
        run: |
          cd tests/e2e
          npm ci

      - name: Install Playwright Browsers
        run: |
          cd tests/e2e
          npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run Playwright Tests
        run: |
          cd tests/e2e
          npx playwright test --project=${{ matrix.browser }}
        env:
          CI: true
          WEBGL_URL: http://localhost:8080

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-${{ matrix.browser }}-results
          path: |
            tests/e2e/test-results/
            tests/e2e/playwright-report/
          retention-days: 14

  # ============================================================
  # Maestro E2E Tests (Android)
  # ============================================================
  e2e-android:
    name: E2E Tests (Android - ${{ matrix.device }})
    runs-on: ubuntu-latest
    needs: build-android
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.run_e2e == 'true' ||
      github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        include:
          - device: pixel_8
            api-level: 34
            profile: pixel_8
          - device: pixel_tablet
            api-level: 34
            profile: pixel_tablet
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Android Build
        uses: actions/download-artifact@v4
        with:
          name: Android-Build
          path: build/Android

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD Cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}-${{ matrix.profile }}

      - name: Run E2E Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: google_apis
          arch: x86_64
          profile: ${{ matrix.profile }}
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            # Find and install APK
            APK_PATH=$(find build/Android -name "*.apk" | head -1)
            echo "Installing APK: $APK_PATH"
            adb install "$APK_PATH"

            # Wait for app to be installed
            sleep 5

            # Run Maestro tests
            maestro test .maestro/flows/ \
              --env ANDROID_APP_ID=com.ironfrontier.game \
              --format junit \
              --output maestro-results \
              || true

            # Always upload screenshots even on failure
            mkdir -p .maestro/screenshots
            adb exec-out screencap -p > .maestro/screenshots/final-state.png || true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maestro-${{ matrix.device }}-results
          path: |
            maestro-results/
            .maestro/screenshots/
          retention-days: 14

  # ============================================================
  # Summary Report
  # ============================================================
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [test, build-webgl, build-android, e2e-webgl, e2e-android]
    if: always()
    steps:
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          path: all-results
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "# Iron Frontier CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unity Tests | ${{ needs.test.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WebGL Build | ${{ needs.build-webgl.result == 'success' && '✅ Success' || (needs.build-webgl.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.build-android.result == 'success' && '✅ Success' || (needs.build-android.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### WebGL (Playwright)" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY

          for browser in chromium firefox; do
            if [ -d "all-results/playwright-${browser}-results" ]; then
              echo "| $browser | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $browser | ⏭️ Skipped/Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Android (Maestro)" >> $GITHUB_STEP_SUMMARY
          echo "| Device | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          for device in pixel_8 pixel_tablet; do
            if [ -d "all-results/maestro-${device}-results" ]; then
              echo "| $device | ✅ Completed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $device | ⏭️ Skipped/Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Iron Frontier CI/CD Pipeline*" >> $GITHUB_STEP_SUMMARY
