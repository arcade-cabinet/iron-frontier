# Iron Frontier E2E Test: Tutorial Combat
# Tests the combat system basics
#
# Platforms: Android (Pixel 8a, Pixel Tablet)
# Priority: P1 (High)

appId: ${ANDROID_APP_ID}
name: Tutorial Combat Test
tags:
  - combat
  - tutorial
  - p1

---
# This flow can run after starting a new game
# Wait for combat UI to appear (triggered by tutorial or encounter)

- extendedWaitUntil:
    visible:
      text: "Attack"
    timeout: 60000
    optional: true

# If combat UI is visible, test combat actions
- runFlow:
    when:
      visible:
        text: "Attack"
    commands:
      - takeScreenshot: screenshots/05-combat-started

      # Test basic attack
      - tapOn:
          text: "Attack"
          retryTapIfNoChange: true

      - waitForAnimationToEnd:
          timeout: ${ANIMATION_TIMEOUT}

      # Verify damage/action occurred
      - takeScreenshot: screenshots/05-attack-executed

      # Test defend action if available
      - tapOn:
          text: "Defend"
          optional: true
      - waitForAnimationToEnd:
          timeout: ${ANIMATION_TIMEOUT}

      # Test item menu if available
      - runFlow:
          when:
            visible:
              text: "Item"
          commands:
            - tapOn:
                text: "Item"
            - waitForAnimationToEnd:
                timeout: ${ANIMATION_TIMEOUT}
            - takeScreenshot: screenshots/05-item-menu
            - tapOn:
                text: "Back"
                optional: true
            - tapOn:
                text: "Cancel"
                optional: true
            - back:
                optional: true

      # Test skill menu if available
      - runFlow:
          when:
            visible:
              text: "Skill"
          commands:
            - tapOn:
                text: "Skill"
            - waitForAnimationToEnd:
                timeout: ${ANIMATION_TIMEOUT}
            - takeScreenshot: screenshots/05-skill-menu
            - tapOn:
                text: "Back"
                optional: true
            - tapOn:
                text: "Cancel"
                optional: true
            - back:
                optional: true

      - takeScreenshot: screenshots/05-combat-actions-tested

# Continue attacking until combat ends or timeout
- repeat:
    times: 5
    commands:
      - runFlow:
          when:
            visible:
              text: "Attack"
          commands:
            - tapOn:
                text: "Attack"
            - waitForAnimationToEnd:
                timeout: ${ANIMATION_TIMEOUT}

# Wait for combat to end
- waitForAnimationToEnd:
    timeout: ${LONG_TIMEOUT}

# Check for victory/defeat screen
- assertVisible:
    text: ".*"
    timeout: ${DEFAULT_TIMEOUT}

- takeScreenshot: screenshots/05-combat-complete
